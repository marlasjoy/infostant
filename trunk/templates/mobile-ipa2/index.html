<!DOCTYPE html> 
<html> 
    <head> 
    <title>Infostant</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> 
    
    <link rel="stylesheet" href="jquery.mobile.min.css" />
    <link rel="stylesheet" href="jquery.mobile.structure.min.css" />
    <link rel="stylesheet" href="jquery.mobile.min.style.css" />
    <link rel="stylesheet" href="css/royal-slider-6.0.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="jquery.fancybox-1.3.4/fancybox/jquery.fancybox-1.3.4.css" rel="stylesheet">
      <script src="jquery-1.7.1.min.js"></script>
    <script src="jquery.animate-enhanced.min.js"></script>
    
    <script src="jquery.mobile.min.js"></script>
    <script src="jquery.easing.1.3.min.js"></script>
    <script src="royal-slider-6.0.min.js"></script>  
    <script src="jquery.fancybox-1.3.4/fancybox/jquery.fancybox-1.3.4.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false" type="text/javascript"></script>
    <script src="plugins.js"></script> 
    <script src="phonegap-1.2.0.js"></script>  
    <script type="text/javascript">



var myObject ; 
var map ;
var beaches;
var initialLocation;
var myLatLng;
var directionDisplay;
var directionsService = new google.maps.DirectionsService();
var myObject2;
var toend;
var setnow=0;
var nowcenter=0;
var nowzoom=0;


function setMap()
{
    $('#hidden_link').fancybox({
     'width' : '310',
     'height' :'950',
     'centerOnScroll':true,
 
     'onClosed': function() {
   var src2="http://www.infostant.com/images/default/icons/spiral.gif";
    $("#mapimage").attr("src",src2);
  } 
    
});
$.post('http://www.infostant.com/ajax/getlatbyshopforiphone',{shopurl:getUrlVars2()['shopurl'],category:getUrlVars2()['category'] },function(data) {   

myObject2 = eval('(' + data + ')'); 
var temp=myObject2.json2;
myObject=eval('(' + temp + ')'); 
temp=myObject2.json;
beaches=[eval(temp)];        
//document.addEventListener("deviceready",onDeviceReady,false);  
 onDeviceReady();

});
}

function getlocation(position)
{
   initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);

   calcRoute();   
    //  map.setCenter(initialLocation); 
  //    myMarkers(map,initialLocation); 
      
} 
function getdetect()
{
      
       if(navigator.geolocation) {

           
           
    browserSupportFlag = true;
    var options =  { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true };

    navigator.geolocation.getCurrentPosition(getlocation,handleNoGeolocation,options);
  // Try Google Gears Geolocation
  } else if (google.gears) {
    
    browserSupportFlag = true;
    var geo = google.gears.factory.create('beta.geolocation');
    geo.getCurrentPosition(function(position) {
      initialLocation = new google.maps.LatLng(position.latitude,position.longitude);
      map.setCenter(initialLocation);
      myMarkers(map,initialLocation,beaches); 
    }, function() {
      handleNoGeoLocation(browserSupportFlag);
    });
  // Browser doesn't support Geolocation
  } else {
 //  alert('3');
    browserSupportFlag = false;
    handleNoGeolocation(browserSupportFlag);
  }
  
  function handleNoGeolocation(errorFlag) {
     // alert('code: '    + errorFlag.code    + '\n' +
     //         'message: ' + errorFlag.message + '\n');
     
     if(errorFlag.code==2)
     {
         navigator.notification.alert('เปิด GPS ด้วยค่ะ');  
     }

    //map.setCenter(initialLocation);
  }
  //var t=setTimeout("getdetect()",5000) ; 
} 
function onDeviceReady()
 {

   directionsDisplay = new google.maps.DirectionsRenderer({preserveViewport: true });   
  var myOptions = {
    zoom: 20,
    center: new google.maps.LatLng(myObject2.latnew,myObject2.lngnew),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
   map = new google.maps.Map(document.getElementById("map_canvas"),
                                myOptions);
    directionsDisplay.setMap(map);
  //   myMarkers() ;
     
     setMarkers(map, beaches);
     setMarkerPoint();
     getdetect();
     
     google.maps.event.addListener(map, 'center_changed', function() {
         
         nowcenter=map.getCenter();
         
     });  
     
     
     google.maps.event.addListener(map, 'zoom_changed', function() {
         
         nowzoom=map.getZoom();
         
     });                        
                                
                                
  
}
function setMarkerPoint()
{
     if(beaches.length==1)
   {
   for (var i = 0; i < beaches.length; i++) { 
    var beach = beaches[i];
    var myLatLng = new google.maps.LatLng(beach[1], beach[2]);
    toend =myLatLng;
 
   }
   }
}
function myMarkers()
{
    
    var image = new google.maps.MarkerImage('http://www.infostant.com/images/default/icons/walk.png',
      // This marker is 20 pixels wide by 32 pixels tall.
      new google.maps.Size(38,40),
      // The origin for this image is 0,0.
      new google.maps.Point(0,0),
      // The anchor for this image is the base of the flagpole at 0,32.
      new google.maps.Point(0, 20));
    var shape = {
      coord: [1, 1, 1, 20, 18, 20, 18 , 1],
      type: 'poly'
  };   
   // var myLatLng = new google.maps.LatLng(beach[1], beach[2]);
    var marker = new google.maps.Marker({
        position: initialLocation,
        map: map,
        icon: image,
        shape: shape,
        title: 'คุณอยู่ที่นี่',
        zIndex: 10
    });
    
    google.maps.event.addListener(marker, 'click', function() {
      //  alert(marker.getPosition().lat());
    //    setdata(marker);
            
   //     $("#hidden_link").trigger('click');
        toggleBounce(marker);
  });
  
}
function calcRoute() {
   // var start = document.getElementById("start").value;
    //var end = document.getElementById("end").value;
    var request = {
        origin:initialLocation, 
        destination:toend,
        travelMode: google.maps.DirectionsTravelMode.DRIVING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        if(nowcenter)
        {
         if(nowzoom)
         {
           map.setZoom(nowzoom);  
         }else
         {
           map.setZoom(20);  
         }
          
          map.setCenter(nowcenter);  
            
        }else
        {
            map.setZoom(20);
        map.setCenter(initialLocation);
        }
        
             
      }
    });
  }

function setMarkers(map, locations) {
  // Add markers to the map
 // alert(locations);
  // Marker sizes are expressed as a Size of X,Y
  // where the origin of the image (0,0) is located
  // in the top left of the image.

  // Origins, anchor positions and coordinates of the marker
  // increase in the X direction to the right and in
  // the Y direction down.
  var dataset=myObject[1]; 
 //alert(dataset.icon);
  var image = new google.maps.MarkerImage('http://www.infostant.com/images/default/icons/'+dataset.icon,
      // This marker is 20 pixels wide by 32 pixels tall.
      new google.maps.Size(dataset.width, dataset.height),
      // The origin for this image is 0,0.
      new google.maps.Point(0,0),
      // The anchor for this image is the base of the flagpole at 0,32.
      new google.maps.Point(0, 35));
 // var shadow = new google.maps.MarkerImage('images/beachflag_shadow.png',
      // The shadow image is larger in the horizontal dimension
      // while the position and offset are the same as for the main image.
//      new google.maps.Size(37, 32),
//      new google.maps.Point(0,0),
//      new google.maps.Point(0, 32));
      // Shapes define the clickable region of the icon.
      // The type defines an HTML &amp;lt;area&amp;gt; element 'poly' which
      // traces out a polygon as a series of X,Y points. The final
      // coordinate closes the poly by connecting to the first
      // coordinate.
  var shape = {
      coord: [1, 1, 1, 20, 18, 20, 18 , 1],
      type: 'poly'
  };
  for (var i = 0; i < locations.length; i++) {
    var beach = locations[i];
    var myLatLng = new google.maps.LatLng(beach[1], beach[2]);
    var marker = new google.maps.Marker({
        position: myLatLng,
        map: map,
        icon: image,
        shape: shape,
        title: beach[0],
        zIndex: beach[3]
    });
   setevent(marker);
   
  }
}

function setdata(marker)
{
   map.setCenter(new google.maps.LatLng(marker.getPosition().lat(), marker.getPosition().lng())); 
    var postion=marker.getPosition().toUrlValue();
    var dataset=myObject[marker.getZIndex()];
    
    $("#title").html(dataset.title);
    $(".namepost").html(dataset.namepost);
    $("#description").html(dataset.description);
    $("#emailshop").html(dataset.emailshop);
    $("#tel").html(dataset.tel);
    $("#address").html(dataset.address); 
    $("#shopname").html(dataset.shopname); 
    $("#shopurl").html(dataset.shopurl);   
    var src3=dataset.pic;
    $("#mapimage2").attr("src",src3);
    
   // alert(lat);
  //  var lng=marker.getPosition().lng();
    var src="http://maps.googleapis.com/maps/api/staticmap?&sensor=false&center="+postion+"&zoom=17&size=301x220&sensor=false&markers=icon:http://www.infostant.com/images/default/icons/"+dataset.icon+"|"+postion+"&format=png";
    $("#mapimage").attr("src",src);
    
}
function setevent(marker)
{
        google.maps.event.addListener(marker, 'click', function() {
      //  alert(marker.getPosition().lat());
        setdata(marker);
            
        $("#hidden_link").trigger('click');
        toggleBounce(marker);
  });
    
}
function stopmarker(marker)
{
    marker.setAnimation(null);
}
function toggleBounce(marker) {

  if (marker.getAnimation() != null) {
    marker.setAnimation(null);
  } 
  else {
    marker.setAnimation(google.maps.Animation.BOUNCE);
     setTimeout(function() {
      stopmarker(marker);
    },  4000);

  }
}

</script>
    
</head> 
<body> 

<div id="index" data-role="page">

    <div data-role="header" data-position="fixed">
        <div>
            <h1><a href="index.html" data-transition="flip">infostant</a></h1>
            <nav>
                <ul class="h">
                    <li><a href="search.html" data-transition="slide">search</a></li>
                    <li><a class="functionclick" href="#">function</a></li>
                    <li><a href="directory.html" data-transition="slide">directory</a></li>
                </ul>
            </nav>
        </div>
        <div  id="function">
            <ul class="v">
                <li><a href="setting.html"><span>Settings</span></a></li>
                <li><a href="directory.html"><span>Directory</span></a></li>
                <li><a href="recent.html"><span>Recent View</span></a></li>
                <li><a href="favarite.html"><span>Favorite</span></a></li>
                <li><a href="calendar.html"><span>Calendar / Itenary</span></a></li>
                <li><a href="memory.html"><span>Personal Memory</span></a></li>
                <li><a href="add_friend.html"><span>Add Friend</span></a></li>
                <li><a href="notification.html"><span>Notification</span></a></li>
                <li><a href="promotion.html"><span>Promotion</span></a></li>
                <li><a href="qr.html"><span>QR Reader</span></a></li>
                <li><a href="location.html"><span>Show Location</span></a></li>
                <li><a href="shop.html"><span>Shop</span></a></li>
                <li><a href="help.html"><span>Help</span></a></li>
            </ul>
            <a href="javascript:void(0);" class="close">Close Function</a>
        </div> <!-- #function -->
    </div><!-- /header -->
    

    <div data-role="content">    
            <!-- <img src="images/img-intro2.jpg" alt="img-intro2" /> -->
    </div><!-- /content -->

    <div data-role="footer" data-position="fixed">
        <ul class="h">
            <li><a href="#"><img src="images/img-group-01.jpg" alt="img-group-01" /></a></li>
            <li><a href="#"><img src="images/img-group-02.jpg" alt="img-group-01" /></a></li>
        </ul>
    </div><!-- /footer -->
</div><!-- /page -->

<script type="text/javascript">
$(document).bind("mobileinit", function(){
  $.mobile.touchOverflowEnabled = true;
});        
</script>
</body>
</html>